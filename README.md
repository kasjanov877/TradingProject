# Тинькофф Инвест API: Веб-хук для размещения ордеров

Этот сервис использует Flask для создания веб-сервера и библиотеку Tinkoff Invest для работы с API Тинькофф Инвестиций. Также используется работа с JSON для хранения данных о тикерах и их идентификаторах (FIGI и UID).

## Основные компоненты

- **TOKEN**: Токен доступа к API Тинькофф Инвестиций (SANDBOX).
- **Flask**: Веб-фреймворк для обработки запросов и работы с вебхуками.
- **Tinkoff Invest SDK**: Официальная библиотека для работы с API Тинькофф Инвестиций, включая размещение ордеров.

## Инициализация

- **account_id**: Идентификатор песочного аккаунта, инициализируется как `None`.
- **ticker_to_figi_uid_library**: Словарь для хранения соответствия тикеров и идентификаторов инструментов (FIGI и UID).

## Основные функции

1. **initialize_libraries(tokens_to_figis_file)**  
   Загружает данные из JSON-файла в глобальный словарь `ticker_to_figi_uid_library`. Этот файл должен содержать соответствия тикеров и их идентификаторов.

2. **get_full_instrument(client, ticker)**  
   Получает полную информацию об инструменте по тикеру через API. Если тикер не найден в библиотеке, запрашивает данные у Тинькофф Инвестиций.

3. **get_quantity(expected_sum, instrument_lot, price=None)**  
   Рассчитывает количество лотов для ордера. Если цена указана, вычисляет количество на основе цены, иначе использует ожидаемую сумму для расчета.

4. **place_order(client, ticker, direction, expected_sum, price=None)**  
   Размещает ордер через API Тинькофф Инвестиций. Определяет тип ордера (рыночный или лимитный) на основе наличия цены и отправляет запрос на размещение ордера.

## Веб-хук

**/webhook**  
Обрабатывает POST-запросы. Получает данные в формате JSON с обязательными полями: `ticker`, `direction`, `expected_sum`, и `price`. Преобразует данные и вызывает функцию `place_order` для размещения ордера через API Тинькофф.

Пример запроса:

```json
{
  "ticker": "AAPL",
  "direction": "buy",
  "expected_sum": 100000,
  "price": "145.30"
}
```
Ответ:

```json
{
  "order_id": "1234567890"
}
```
Если данные некорректны или отсутствуют обязательные поля, сервис вернет ошибку с описанием проблемы.

## Инициализация песочницы
Функция initialize_sandbox_account(client) загружает данные о песочном аккаунте или создает новый. В случае создания нового аккаунта, он пополняется на 200 000 рублей (по умолчанию).

## Запуск сервера
Для запуска сервера и обработки вебхуков выполните команду:  
### Python3
```cmd
python3 app.py
```
### Python
```cmd
python app.py
```
Сервер будет слушать на порту 5000.

## Примечания
Токен: Заданный токен используется для работы в песочнице Тинькофф Инвестиций. Для использования в реальной среде необходимо заменить его на рабочий токен.

Файл с данными тикеров: Для корректной работы необходимо подготовить файл tokens_figi_uid.json с данными тикеров и их идентификаторов (FIGI и UID).

## Лицензия
Этот проект распространяется под лицензией MIT.  
